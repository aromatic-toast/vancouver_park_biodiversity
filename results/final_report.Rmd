---
title: "Biodiversity in Vancouver Parks"
author: "Lesley Miller"
date: "07/06/2020"
output: 
  html_document:
    toc: true
    theme: darkly
    pandoc_args: --webtex
always_allow_html: true
bibliography: citations.bib
runtime: shiny
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
knitr::opts_knit$set(root.dir = here::here())
library(shiny)
suppressPackageStartupMessages(library(tidyverse))
library(sf)
library(knitr)
library(gridExtra)
library(grid)
library(shinythemes)
library(hrbrthemes)
```

```{r load_data}
# load gbif
gbif <- st_read('data/clean_data/vancouver_gbif.shp', quiet = TRUE)

# load all parks w/metrics 
parks <- read_csv("data/clean_data/all_parks_with_metrics.csv", col_types = cols()) # 
parks <- parks %>% 
      select(park_name, species_count, species_richness)

# load clipped_gbif
clipped_gbif <- st_read('data/clean_data/clipped_gbif.shp', quiet = TRUE)
clipped_gbif <- clipped_gbif %>% 
      rename(basis_of_record = basis_of_r)

# load outlier parks
outlier_parks <-  st_read('data/clean_data/park_outliers.shp', quiet = TRUE)
outlier_parks <- outlier_parks %>% 
      rename(park_primary_use = park_prima,
             species_counts = species_co,
             species_richness = species_ri )

# load parks with no outliers 
parks_with_no_outliers <- st_read('data/clean_data/parks_with_no_outliers.shp', quiet = TRUE)
parks_with_no_outliers <- parks_with_no_outliers %>% 
      rename(park_primary_use = park_prima,
             species_counts = species_co,
             species_richness = species_ri)
```


## Introduction

```{r park_use}
park_use <- tibble(Use_Table = unique(parks_with_no_outliers$park_primary_use))
kable(park_use, caption = "Primary Uses of Vancouver Parks")
```





## Data Sources {.tabset .tabset-pills}

### GBIF Data
```{r gbif_data}
# gbif data table

shinyApp(
  ui = fluidPage(
    theme = shinytheme("cerulean"),
    fluidRow(
      column(12,
        dataTableOutput('table1')
      )
    )
  ),
  server = function(input, output) {
    output$table1 <- renderDataTable(head(clipped_gbif,50))
  }
)

```

### Parks Data
```{r parks_data}

# DataTables 
shinyApp(
  ui = fluidPage(
    theme = shinytheme("cerulean"),
    fluidRow(
      column(12,
        dataTableOutput('table2')
      )
    )
  ),
  server = function(input, output) {
    output$table2 <- renderDataTable(parks_with_no_outliers)
  }
)

```

`

## Observation Hotspots {.tabset .tabset-pills}

### Proportion In Parks
```{r}
# get relative proportions of observations inside and outside parks 
observed_in_park <- nrow(clipped_gbif)
outside_park <-  nrow(gbif) - observed_in_park

species_in_out_df <- tibble(count_observed_in_park = c('yes', 'no'),
                            count = c(observed_in_park, outside_park))

pie <- species_in_out_df %>% 
  ggplot(aes(x= factor(1), fill = count_observed_in_park)) +
  geom_bar(width = 1) +
  coord_polar("y") + 
  theme(axis.text = element_blank(),
        axis.ticks = element_blank(),
        axis.title = element_blank()) + 
  labs(title = "Relative Proportion of Observations in Parks")

pie
```


### No Outliers
```{r}
# Question 2: What are the top 10 parks with the highest observations?
obs_hotspots_no_outliers <- parks_with_no_outliers %>% 
      arrange(desc(species_counts)) %>% 
      head(10) %>% 
      select(park_name, species_counts, species_richness)

plot2 <- obs_hotspots_no_outliers %>% 
      ggplot(aes(x = reorder(park_name, species_counts), y = species_counts)) + 
      geom_col() + 
      labs(title = "Top Ten Observation Hotspots",
           x = 'Park Name',
           y = 'Count of Observations') +
      coord_flip() 
plot2
```


### Outliers
```{r}
#### outliers #### 
plot2_1 <- outlier_parks %>% 
      ggplot(aes(x = park_name, species_counts)) +
      geom_col() + 
      labs(title = "Outlier Observation Hotspots",
           x = 'Park Name',
           y = 'Count of Observations') +
      coord_flip()
plot2_1
```


## Highest Unique Species {.tabset .tabset-pills}

### No Outliers
```{r}
##### Question 3: which parks have the most species richness? ##### 
top_species_rich <- parks_with_no_outliers %>% 
      arrange(desc(species_richness)) %>% 
      head(10) %>% 
      select(park_name, species_counts, species_richness)

plot3 <- top_species_rich %>% 
      ggplot(aes(x = reorder(park_name, species_richness), y = species_richness)) + 
      geom_col() + 
      labs(title = "Top Ten Parks for Species Richness",
           x = 'Park Name',
           y = 'Unique Species Count') +
      coord_flip()
plot3
```

### Outliers
```{r}
### outliers species richnesss ###
plot3_1 <- outlier_parks %>% 
      ggplot(aes(x = reorder(park_name, species_richness), y = species_richness)) + 
      geom_col() + 
      labs(title = "Outlier Parks for Species Richness",
           x = 'Park Name',
           y = 'Unique Species Count') +
      coord_flip()
plot3_1
```



# Analysis Methods 

This analysis was carried out with the amazing help from the following open source R packages: R [@R], tidyverse [@tidyverse], here [@here], gridExtra [@gridExtra] and sf [@sf]. And the following Python packages: Python [@Python], NumPy [@oliphant2006guide], GeoPandas [@geopandas0.7.0], Pandas [@pandas] and kepler.gl [@keplergl].

# References
